<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng Ký Buổi Tư Vấn</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      overflow-x: hidden;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .main-container { flex: 1; overflow-y: auto; padding-bottom: 65px; }
    .footer-wrapper { position: fixed; bottom: 0; width: 100%; height: 65px; z-index: 1000; }

    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .form-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(3, 136, 180, 0.08);
      margin: 30px 20px;
      animation: slideInUp 0.6s ease;
      border-top: 4px solid #0388B4;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .form-section:hover { transform: translateY(-8px); box-shadow: 0 16px 40px rgba(3, 136, 180, 0.2); }

    .section-title {
      font-size: 22px; font-weight: 700; color: #0388B4; margin-bottom: 25px;
      border-bottom: 2px solid #0388B4; padding-bottom: 12px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group.hidden { display: none; }
    .form-group.toggle-field { animation: slideDown 0.4s ease; overflow: hidden; }
    .form-group.toggle-field.hide { animation: slideUp 0.4s ease; }

    .form-label { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; display: block; text-transform: uppercase; }
    .form-label .required { color: #e74c3c; }

    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px 14px; border: 2px solid #e0e0e0; border-radius: 8px;
      font-family: 'Poppins', sans-serif; font-size: 14px; transition: all 0.3s ease;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none; border-color: #0388B4; box-shadow: 0 0 0 3px rgba(3, 136, 180, 0.1); background: #f0f8fb;
    }
    .form-textarea { resize: vertical; min-height: 100px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .radio-group { display: flex; gap: 30px; margin-top: 12px; }
    .radio-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .radio-item input[type="radio"] { width: 20px; height: 20px; accent-color: #0388B4; }
    .number-input-group { display: flex; gap: 15px; }
    .number-input-group .form-input { flex: 1; }

    .button-group { display: flex; gap: 15px; margin-top: 30px; justify-content: flex-end; }
    .btn {
      padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
    }
    .btn-primary { background: #0388B4; color: white; box-shadow: 0 4px 12px rgba(3, 136, 180, 0.3); }
    .btn-primary:hover { background: #026689; transform: translateY(-2px); }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-secondary:hover { background: #ccc; transform: translateY(-2px); }

    /* Modal Xác Nhận */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center;
      z-index: 2000; animation: fadeIn 0.3s ease;
    }
    .modal-content {
      background: white; border-radius: 12px; width: 90%; max-width: 480px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideInUp 0.4s ease;
    }
    .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .modal-header h3 { margin: 0; color: #0388B4; font-size: 18px; font-weight: 600; }
    .modal-close { font-size: 28px; cursor: pointer; color: #aaa; }
    .modal-close:hover { color: #e74c3c; }
    .modal-body { padding: 20px; line-height: 1.6; }
    .modal-footer { padding: 15px 20px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #eee; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 768px) {
      .form-row, .number-input-group, .button-group { grid-template-columns: 1fr; flex-direction: column; }
      .btn { width: 100%; }
      .radio-group { flex-direction: column; gap: 15px; }
      .form-section { margin: 20px 15px; padding: 20px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <iframe src="../header.html" style="width: 100%; border: none; overflow: hidden; display: block;"></iframe>

  <script>
    let thongtin = null;
    const urlParams = new URLSearchParams(window.location.search);
    const ticket = urlParams.get('ticket');
    const serviceUrl = window.location.href;

    function removeTicketFromUrl() {
      const url = new URL(window.location.href);
      url.searchParams.delete('ticket');
      window.history.replaceState({}, document.title, url.toString());
    }

    async function run() {
      if (!ticket) {
        window.location.href = `https://casserver-production.up.railway.app/cas/login?service=${encodeURIComponent(serviceUrl)}`;
        return;
      }
      const response = await fetch('http://localhost:8087/userinfo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticket, service: serviceUrl.split('?')[0] })
      });
      const data = await response.json();
      if (!data.success) { removeTicketFromUrl(); return null; }
      removeTicketFromUrl();
      return data.attributes;
    }

    (async () => { thongtin = await run(); })();
  </script>

 
  <div class="main-container">
    <div class="form-section">
      <div class="section-title">Tạo Buổi Tư Vấn Mới</div>
      
      <form id="consultationForm">
        <div class="form-group">
          <label class="form-label">Tên buổi tư vấn <span class="required">*</span></label>
          <input type="text" class="form-input" id="title" placeholder="Nhập tên buổi tư vấn" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Thời gian bắt đầu <span class="required">*</span></label>
            <input type="datetime-local" class="form-input" id="startTime" required>
          </div>
          <div class="form-group">
            <label class="form-label">Thời gian kết thúc <span class="required">*</span></label>
            <input type="datetime-local" class="form-input" id="endTime" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Số lượng sinh viên <span class="required">*</span></label>
          <div class="number-input-group">
            <input type="number" class="form-input" id="minStudents" placeholder="Tối thiểu" min="1" required>
            <input type="number" class="form-input" id="maxStudents" placeholder="Tối đa" min="1" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Hình thức <span class="required">*</span></label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" id="offline" name="format" value="offline" checked>
              <label for="offline">Offline</label>
            </div>
            <div class="radio-item">
              <input type="radio" id="online" name="format" value="online">
              <label for="online">Online</label>
            </div>
          </div>
        </div>

        <div class="form-group toggle-field" id="offlineField">
          <label class="form-label">Địa chỉ phòng <span class="required">*</span></label>
          <select class="form-select" id="roomSelect" required>
            <option value="">-- Chọn phòng --</option>
            <option value="room-101">Phòng 101 - Tầng 1</option>
            <option value="room-201">Phòng 201 - Tầng 2</option>
            <option value="room-301">Phòng 301 - Tầng 3</option>
            <option value="room-401">Phòng 401 - Tầng 4</option>
            <option value="room-501">Phòng 501 - Tầng 5</option>
          </select>
        </div>

        <div class="form-group toggle-field hidden" id="onlineField">
          <label class="form-label">Link Zoom/Google Meet <span class="required">*</span></label>
          <input type="url" class="form-input" id="onlineLink" placeholder="https://meet.google.com/..." required>
        </div>

        <div class="form-group">
          <label class="form-label">Yêu cầu khác</label>
          <textarea class="form-textarea" id="notes" placeholder="Nhập ghi chú (nếu có)"></textarea>
        </div>

        <div class="button-group">
          <button type="reset" class="btn btn-secondary">Hủy</button>
          <button type="submit" class="btn btn-primary">Tạo buổi tư vấn</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Xác Nhận -->
  <div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Xác nhận tạo buổi tư vấn</h3>
        <span class="modal-close">×</span>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn <strong>tạo buổi tư vấn</strong> này không?</p>
        <p>Dữ liệu sẽ được lưu và không thể chỉnh sửa sau khi xác nhận.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelBtn">Hủy bỏ</button>
        <button type="button" class="btn btn-primary" id="confirmBtn">Xác nhận tạo</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer-wrapper">
    <iframe src="../footer.html" style="width: 100%; border: none; height: 100%;"></iframe>
  </div>
  <script type="module" src="/tutor/data"></script>
  <script>
  // Elements
  const form = document.getElementById('consultationForm');
  const modal = document.getElementById('confirmModal');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const closeBtn = document.querySelector('.modal-close');
  const submitBtn = document.querySelector('button[type="submit"]');

  // Toast notification function
  function showToast(message, type = 'success') {
    // Remove old toast if exists
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
      <span>${message}</span>
      <div class="toast-progress"></div>
    `;
    document.body.appendChild(toast);

    // Force reflow then animate
    requestAnimationFrame(() => toast.classList.add('show'));

    // Auto remove after 4s
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Toggle Offline / Online fields
  function toggleFields() {
    const isOnline = document.getElementById('online').checked;
    document.getElementById('offlineField').classList.toggle('hidden', isOnline);
    document.getElementById('onlineField').classList.toggle('hidden', !isOnline);
    document.getElementById('roomSelect').required = !isOnline;
    document.getElementById('onlineLink').required = isOnline;
  }
  document.querySelectorAll('input[name="format"]').forEach(radio => radio.addEventListener('change', toggleFields));
  form.addEventListener('reset', () => {
    document.getElementById('offline').checked = true;
    setTimeout(toggleFields, 50);
  });
  toggleFields(); // init

  // Modal controls
  function openModal() {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  closeBtn.onclick = cancelBtn.onclick = closeModal;
  modal.onclick = e => { if (e.target === modal) closeModal(); };

  // Submit → show modal
  form.addEventListener('submit', e => {
    e.preventDefault();
    if (form.checkValidity()) {
      openModal();
    } else {
      form.reportValidity();
    }
  });

  // Xác nhận → gọi create_session()
  confirmBtn.onclick = async () => {
    closeModal();

    // Disable button + show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

    const data = {
      title: document.getElementById('title').value.trim(),
      start_time: document.getElementById('startTime').value,
      end_time: document.getElementById('endTime').value,
      min_students: parseInt(document.getElementById('minStudents').value),
      max_students: parseInt(document.getElementById('maxStudents').value),
      format: document.querySelector('input[name="format"]:checked').value,
      location: document.querySelector('input[name="format"]:checked').value === 'offline'
        ? document.getElementById('roomSelect').value
        : null,
      online_link: document.querySelector('input[name="format"]:checked').value === 'online'
        ? document.getElementById('onlineLink').value.trim()
        : null,
      notes: document.getElementById('notes').value.trim() || null,
      creator: thongtin // Thông tin người tạo từ CAS
    };

    try {
      const result = await create_session(data);

      // Nếu API trả về mảng lỗi
      const res = Array.isArray(result) ? result[0] : result;

      if (res.status === "created") {
          showToast('Tạo buổi tư vấn thành công!', 'success');
          form.reset();
          toggleFields();
      } else {
          throw new Error(res.message || 'Tạo thất bại');
      }

  } catch (err) {
      console.error('Lỗi tạo buổi tư vấn:', err);
      showToast(err.message || 'Đã có lỗi xảy ra. Vui lòng thử lại!', 'error');
  } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Tạo buổi tư vấn';
  }
  };
</script>

<!-- Toast CSS - Thêm vào cuối <style> hoặc để riêng -->
<style>
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 9999;
    min-width: 300px;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-10px);
  }
  .toast i { font-size: 24px; }
  .toast-success i { color: #27ae60; }
  .toast-error i { color: #e74c3c; }
  .toast span { font-weight: 600; color: #333; }
  .toast-progress {
    position: absolute;
    bottom: 0; left: 0; height: 4px; width: 100%;
    background: rgba(0,0,0,0.1);
  }
  .toast-progress::after {
    content: '';
    display: block;
    height: 100%;
    background: #0388B4;
    animation: toastProgress 4s linear forwards;
  }
  .toast-error .toast-progress::after { background: #e74c3c; }

  @keyframes toastProgress {
    from { width: 100%; }
    to { width: 0; }
  }

  @media (max-width: 480px) {
    .toast { min-width: auto; left: 20px; right: 20px; transform: translateX(0); }
    .toast.show { transform: translateY(-10px); }
  }
</style>
</body>
</html>